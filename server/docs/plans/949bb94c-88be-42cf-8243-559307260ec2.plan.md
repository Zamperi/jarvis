# PLAN (DRAFT)
RunId: 949bb94c-88be-42cf-8243-559307260ec2
Task: docs/tasks/Ticket-1-Policy.md
Role: coder
Status: DRAFT

Based on my understanding of the task and the codebase structure, here's my implementation plan:

---

## TITLE
Enforce Policy Checks for All Write & Exec Tools

## SCOPE

**What will change:**
- Modify write_file, apply_patch functions in `src/tools/fileTools.ts`
- Modify run_tests, run_build, run_lint functions in `src/tools/execTools.ts`
- Update the tools to integrate policy checks before execution
- Ensure policy violations prevent tool execution and return structured errors

**What will NOT change:**
- The existing policy logic in `src/tools/policyTools.ts` (already implemented)
- The tool signatures and return types (maintain backward compatibility)
- Read-only operations (they don't need policy checks)

## STEP-BY-STEP PLAN

1. **Update fileTools.ts - write_file function:**
   - Import checkActionAgainstPolicy and related types from policyTools
   - Before writing, create an ActionDescription with kind="writeFile"
   - Call checkActionAgainstPolicy with appropriate policy config
   - If policy check fails, return error result without writing
   - If policy check passes, proceed with existing write logic

2. **Update fileTools.ts - apply_patch function:**
   - Import policy checking functions if not already imported
   - Before applying patch, create ActionDescription with kind="applyPatch"
   - Include estimatedChangedLines based on patch analysis
   - Call checkActionAgainstPolicy
   - If policy check fails, return error result without applying patch
   - If policy check passes, proceed with existing patch logic

3. **Update execTools.ts - run_tests function:**
   - Import checkActionAgainstPolicy and related types
   - Create ActionDescription with kind="runTests"
   - Call checkActionAgainstPolicy before executing tests
   - If policy check fails, return error result
   - If policy check passes, proceed with test execution

4. **Update execTools.ts - run_build function:**
   - Create ActionDescription with kind="runBuild"
   - Call checkActionAgainstPolicy before executing build
   - If policy check fails, return error result
   - If policy check passes, proceed with build execution

5. **Update execTools.ts - run_lint function:**
   - Create ActionDescription with kind="runLint"
   - Call checkActionAgainstPolicy before executing lint
   - If policy check fails, return error result
   - If policy check passes, proceed with lint execution

6. **Create/update policy configuration:**
   - Ensure a default PolicyConfig is available for the tools
   - Define blocked paths (.env, node_modules, dist, etc.)
   - Set reasonable limits for maxFilesChanged and maxTotalChangedLines

## FILES TO TOUCH

1. **src/tools/fileTools.ts**
   - Reason: Contains write_file and apply_patch functions that need policy enforcement

2. **src/tools/execTools.ts**
   - Reason: Contains run_tests, run_build, and run_lint functions that need policy enforcement

3. **src/config/projectConfig.ts** (potentially)
   - Reason: May need to add or update default policy configuration

## RISKS & CHECKS

**Risks:**
- Breaking existing functionality if error handling is not properly implemented
- Performance impact from policy checks on every write/exec operation
- Incorrect policy configuration could block legitimate operations

**Checks to perform after implementation:**
- Test that write operations to blocked paths (.env, node_modules) are rejected
- Test that read operations continue to work without policy checks
- Test that policy violations return structured error messages
- Test that successful policy checks allow operations to proceed normally
- Verify toolUsage logging captures policy violations
- Run existing tests to ensure no regression

**APPROVAL REQUIRED**
